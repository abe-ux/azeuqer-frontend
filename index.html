<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AZEUQER: MODULE 01</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #000; --neon: #00ffcc; --err: #ff0055; }
        body { background: var(--bg); color: #fff; font-family: monospace; text-align: center; padding: 20px; }
        
        /* THE SCANNER */
        .scanner-box {
            border: 2px dashed #333; padding: 30px; margin: 20px 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 200px; transition: 0.3s;
        }
        .scanner-box.active { border-color: var(--neon); background: rgba(0, 255, 204, 0.05); }
        
        /* PREVIEW IMAGE */
        #preview { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 2px solid var(--neon); display: none; margin-bottom: 20px; }
        
        /* CONTROLS */
        .btn {
            background: #111; border: 1px solid var(--neon); color: var(--neon);
            padding: 15px 30px; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; width: 100%;
        }
        .btn:active { background: var(--neon); color: #000; }
        
        /* DEBUG LOG */
        #log { margin-top: 30px; font-size: 0.8rem; color: #555; text-align: left; border-top: 1px solid #333; padding-top: 10px; }
        .log-line { margin-bottom: 5px; }
        .err { color: var(--err); }
        .suc { color: var(--neon); }
    </style>
</head>
<body>

    <h1 style="color:var(--neon); letter-spacing:5px;">BIO-LOCK</h1>
    <p style="color:#888">MODULE 01: IDENTITY</p>

    <div class="scanner-box" id="scan-zone">
        <img id="preview" src="">
        <div id="placeholder">NO SIGNAL</div>
    </div>

    <input type="file" id="cam" accept="image/*" capture="user" style="display:none" onchange="handleFile()">
    
    <button class="btn" onclick="triggerCamera()">ðŸ“¸ INITIATE SCAN</button>

    <div id="log">SYSTEM LOG:</div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = "https://azeuqer-backend.onrender.com"; // UPDATE THIS !!!
        const tg = window.Telegram.WebApp;
        tg.expand();

        function log(msg, type="") {
            const line = document.createElement('div');
            line.className = "log-line " + type;
            line.innerText = "> " + msg;
            document.getElementById('log').prepend(line);
        }

        // 1. AUTO LOGIN (To get User ID)
        async function init() {
            log("Connecting to Core...");
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ initData: tg.initData || "debug_mode" })
                });
                const data = await res.json();
                if(data.status === "ok" || data.status === "created") {
                    log(`User ID: ${data.user.user_id}`, "suc");
                    if(data.user.bio_lock_url) {
                        showPreview(data.user.bio_lock_url);
                        log("Bio-Lock already active.", "suc");
                    }
                } else {
                    log("Login Failed: " + JSON.stringify(data), "err");
                }
            } catch(e) {
                log("Server Connection Error. Check URL.", "err");
            }
        }

        // 2. TRIGGER CAMERA
        function triggerCamera() {
            document.getElementById('cam').click();
        }

        // 3. HANDLE FILE SELECTION
        async function handleFile() {
            const file = document.getElementById('cam').files[0];
            if (!file) {
                log("Scan Cancelled.", "err");
                return;
            }
            log(`File Selected: ${Math.round(file.size/1024)}KB`);
            
            // 4. UPLOAD
            const fd = new FormData();
            fd.append("initData", tg.initData || "debug_mode");
            fd.append("file", file);

            log("Uploading to Cloud...");
            document.querySelector('.scanner-box').classList.add('active');

            try {
                const res = await fetch(`${API_URL}/auth/upload`, { method: "POST", body: fd });
                
                if (!res.ok) throw new Error("Server Reject " + res.status);
                
                const data = await res.json();
                
                if (data.status === "success") {
                    log("UPLOAD COMPLETE.", "suc");
                    showPreview(data.url);
                    alert("IDENTITY CONFIRMED");
                } else {
                    log("Server Error: " + data.msg, "err");
                }
            } catch(e) {
                log("Upload Failed: " + e.message, "err");
            }
        }

        function showPreview(url) {
            document.getElementById('placeholder').style.display = 'none';
            const img = document.getElementById('preview');
            img.src = url;
            img.style.display = 'block';
        }

        init();
    </script>
</body>
</html>
