<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AZEUQER: BIO-LOCK</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #000; --neon: #00ffcc; --err: #ff0055; }
        body { background: var(--bg); color: #fff; font-family: monospace; text-align: center; padding: 20px; overflow-x: hidden; }
        
        /* SCANNER UI */
        .scanner-box {
            border: 2px dashed #333; padding: 30px; margin: 20px 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 250px; transition: 0.3s; position: relative;
            background: #111;
        }
        .scanner-box.active { border-color: var(--neon); background: rgba(0, 255, 204, 0.05); }
        
        #preview { width: 100%; height: 250px; object-fit: cover; border: 2px solid var(--neon); display: none; }
        #placeholder { color: #444; font-size: 0.8rem; }

        /* THE HYBRID TRIGGER */
        .camera-label {
            background: #111; border: 1px solid var(--neon); color: var(--neon);
            padding: 20px; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; width: 100%;
            display: block; box-sizing: border-box; text-align: center;
            margin-top: 20px;
        }
        .camera-label:active { background: var(--neon); color: #000; }

        /* LOG */
        #log { margin-top: 30px; font-size: 0.7rem; color: #555; text-align: left; border-top: 1px solid #333; padding-top: 10px; font-family: monospace; }
        .log-line { margin-bottom: 5px; border-bottom: 1px solid #111; }
        .err { color: var(--err); }
        .suc { color: var(--neon); }
    </style>
</head>
<body>

    <h1 style="color:var(--neon); letter-spacing:5px;">BIO-LOCK</h1>
    <p style="color:#888; font-size: 0.8rem;">SECURE IDENTITY PROTOCOL</p>

    <div class="scanner-box" id="scan-zone">
        <img id="preview" src="">
        <div id="placeholder">NO SIGNAL</div>
    </div>

    <label class="camera-label">
        ðŸ“¸ ACTIVATE CAMERA
        <input type="file" id="cam" accept="image/*" capture="user" style="display:none" onchange="handleFile()">
    </label>

    <div id="log">SYSTEM LOG:</div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = "https://azeuqer-backend.onrender.com"; // UPDATE THIS
        const tg = window.Telegram.WebApp;
        tg.expand();

        function log(msg, type="") {
            const line = document.createElement('div');
            line.className = "log-line " + type;
            line.innerText = "> " + msg;
            document.getElementById('log').prepend(line);
        }

        // 1. AUTO LOGIN
        async function init() {
            log("Initializing Uplink...");
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ initData: tg.initData || "debug_mode" })
                });
                
                const data = await res.json();
                if(data.status === "ok" || data.status === "created") {
                    log(`User ID: ${data.user.user_id}`, "suc");
                    if(data.user.bio_lock_url) {
                        showPreview(data.user.bio_lock_url);
                        log("Bio-Lock Active.", "suc");
                    }
                } else {
                    log("Login Error: " + JSON.stringify(data), "err");
                }
            } catch(e) {
                log("Server Offline or URL Wrong.", "err");
            }
        }

        // 2. HANDLE FILE
        async function handleFile() {
            const file = document.getElementById('cam').files[0];
            if (!file) {
                log("Camera Closed.", "err");
                return;
            }
            
            // Preview Immediately (Juice)
            const reader = new FileReader();
            reader.onload = (e) => showPreview(e.target.result);
            reader.readAsDataURL(file);

            log(`Uploading ${Math.round(file.size/1024)}KB...`);
            
            const fd = new FormData();
            fd.append("initData", tg.initData || "debug_mode");
            fd.append("file", file);

            try {
                const res = await fetch(`${API_URL}/auth/upload`, { method: "POST", body: fd });
                const data = await res.json();
                
                if (data.status === "success") {
                    log("UPLOAD COMPLETE.", "suc");
                    alert("IDENTITY CONFIRMED.");
                } else {
                    log("Server Reject: " + data.msg, "err");
                }
            } catch(e) {
                log("Upload Failed: " + e.message, "err");
            }
        }

        function showPreview(url) {
            document.getElementById('placeholder').style.display = 'none';
            const img = document.getElementById('preview');
            img.src = url;
            img.style.display = 'block';
            document.querySelector('.scanner-box').classList.add('active');
        }

        init();
    </script>
</body>
</html>
