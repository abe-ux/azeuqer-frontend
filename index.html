<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AZEUQER</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #050505; --neon: #00ffcc; --pink: #ff00ff; --glass: rgba(255,255,255,0.05); }
        body { background: var(--bg); color: #fff; font-family: 'Courier New', monospace; margin: 0; padding: 0; overflow: hidden; }
        .hidden { display: none !important; }
        .screen { padding: 20px; text-align: center; height: 100vh; overflow-y: auto; box-sizing: border-box; position: relative; z-index: 2; }

        /* VISUAL JUICE */
        .scanlines { position: fixed; inset: 0; pointer-events: none; z-index: 10; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; }
        
        /* PIONEER GLITCH */
        .pioneer-glitch { position: relative; color: var(--neon); animation: skew 1s infinite alternate; text-shadow: 2px 0 var(--pink); }
        @keyframes skew { 0% { transform: skew(2deg); } 100% { transform: skew(-2deg); } }

        /* GENERAL GLITCH */
        .glitch { font-size: 2rem; font-weight: bold; color: var(--neon); text-shadow: 2px 0 var(--pink); animation: shake 2s infinite; }
        @keyframes shake { 0% { transform: translate(0,0); } 2% { transform: translate(1px,0); } 4% { transform: translate(0,0); } }

        /* THE STAMP (GLOWING OVERLAY) */
        .stamp-overlay {
            position: absolute; bottom: 10px; right: 10px;
            background: rgba(0,0,0,0.8); border: 1px solid var(--neon);
            color: var(--neon); padding: 5px 10px; font-size: 0.7rem; font-weight: bold;
            transform: rotate(-10deg); box-shadow: 0 0 10px var(--neon);
            z-index: 20; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 5px var(--neon); } 100% { opacity: 0.8; } }

        /* CONTROLS */
        .btn { width: 100%; padding: 15px; background: #111; border: 1px solid var(--neon); color: var(--neon); margin-top: 15px; font-size: 1.2rem; font-weight: bold; text-transform: uppercase; cursor: pointer; transition: 0.1s; }
        .btn:active { background: var(--neon); color: #000; transform: scale(0.98); }
        .btn-red { border-color: var(--pink); color: var(--pink); }
        .btn-red:active { background: var(--pink); color: #000; }
        .btn-small { padding: 5px 10px; width: auto; font-size: 0.8rem; margin: 0; }
        
        /* SHEESH BUTTON STYLE */
        .btn-sheesh { border-color: #00ff00; color: #00ff00; box-shadow: 0 0 15px rgba(0,255,0,0.2); }
        .btn-sheesh:active { background: #00ff00; color: #000; }

        /* CARDS */
        .card { width: 100%; max-width: 350px; height: 450px; margin: 0 auto; border: 1px solid #333; position: relative; background: #000; transition: transform 0.2s; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card-overlay { position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, #000, transparent); padding: 20px; box-sizing: border-box; text-align: left; }
        
        /* INVENTORY GRID */
        .inv-item { border: 1px solid #333; padding: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); }
        .inv-item button { padding: 5px; font-size: 0.8rem; width: auto; margin: 0; }

        /* LEADERBOARD LIST */
        .leader-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; }
        .leader-row img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; }

        /* LOADER */
        #loader { position: fixed; inset: 0; background: #000; z-index: 99; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div id="loader" class="hidden"><div class="glitch">CONNECTING...</div></div>

    <div id="screen-entry" class="screen">
        <h1 class="glitch" style="margin-top:50px;">AZEUQER</h1>
        <p style="color:#888; margin-bottom:40px;">// REALITY EXTRACTION</p>
        
        <div style="border: 1px dashed #333; padding: 40px; margin: 20px;">
            <label class="btn">
                üì∏ SCAN FACE
                <input type="file" id="cam" accept="image/*" class="hidden" onchange="uploadBio()">
            </label>
        </div>
        <div id="status-log" style="margin-top:20px; color:#555; font-size: 0.8rem;">AWAITING BIOMETRICS</div>
    </div>

    <div id="screen-feed" class="screen hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span style="color:var(--neon); font-weight:bold;">AP: <span id="hud-ap">0</span></span>
            <div style="display:flex; gap:10px;">
                <button onclick="loadLeaderboard()" style="background:none; border:1px solid #333; color:#fff; padding:5px 10px; cursor:pointer;">üèÜ TOP</button>
                <button onclick="loadProfile()" style="background:none; border:1px solid #333; color:#fff; padding:5px 10px; cursor:pointer;">üë§ ME</button>
            </div>
        </div>

        <div id="feed-container">
            <div style="margin-top:100px;">NO SIGNALS...</div>
        </div>

        <div style="display:flex; gap:15px; position:fixed; bottom:30px; width:90%; left:5%;">
            <button class="btn btn-red" onclick="swipe('SPITE')"> üíÄ SPITE</button>
            <button class="btn btn-sheesh" onclick="swipe('LIGHT')"> üî• SHEESH</button>
        </div>
    </div>

    <div id="screen-profile" class="screen hidden">
        <h2 class="glitch" style="margin-bottom:20px;">PASSPORT</h2>
        
        <div style="position:relative; width:150px; height:150px; margin: 0 auto;">
            <img id="prof-img" src="" style="width:100%; height:100%; border:2px solid var(--neon); object-fit:cover;">
            <div id="prof-stamp" class="stamp-overlay hidden">VOID TOKEN</div>
        </div>
        
        <h2 id="prof-name" style="margin:10px 0; color:#fff;">AGENT</h2>
        <div id="prof-faction" style="color:var(--pink); margin-bottom:20px;">NEUTRAL</div>

        <div id="stat-box" style="margin-top:20px; background:#111; padding:10px; border:1px solid #333; text-align:left;">
            <div style="display:flex; justify-content:space-between;">
                <span style="color:#888;">STATS</span>
                <span style="color:gold;" id="avail-pts">PTS: 0</span>
            </div>
            <div style="margin-top:10px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>STR: <span id="stat-str">0</span></span>
                    <button class="btn btn-small hidden" id="up-str" onclick="upgradeStat('STR')">[+]</button>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>AGI: <span id="stat-agi">0</span></span>
                    <button class="btn btn-small hidden" id="up-agi" onclick="upgradeStat('AGI')">[+]</button>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>INT: <span id="stat-int">0</span></span>
                    <button class="btn btn-small hidden" id="up-int" onclick="upgradeStat('INT')">[+]</button>
                </div>
            </div>
        </div>

        <h3 style="border-bottom:1px solid #333; padding-bottom:5px; text-align:left; margin-top:20px;">INVENTORY</h3>
        <div id="inventory-list" style="text-align:left; max-height: 25vh; overflow-y:auto;">
            </div>

        <button class="btn" onclick="showScreen('screen-feed')">BACK TO FEED</button>
    </div>

    <div id="screen-leaderboard" class="screen hidden">
        <h2 style="color:gold; margin-bottom:20px;">THE ELITE</h2>
        <div id="leader-list" style="text-align:left; height:70vh; overflow-y:auto; border:1px solid #333;">
            </div>
        <button class="btn" onclick="showScreen('screen-feed')">BACK</button>
    </div>

    <div id="screen-combat" class="screen hidden" style="background: #2a0000;">
        <h1 class="glitch" style="color:var(--pink)">AMBUSH</h1>
        <img id="boss-img" src="" style="width:200px; height:200px; border:2px solid red; margin: 20px auto; display:block;">
        <h2 id="boss-name" style="color:red">TARGET</h2>
        <div style="font-size:1.5rem; font-weight:bold;">HP: <span id="boss-hp">???</span></div>
        <div id="combat-log" style="height:100px; overflow-y:scroll; background:#000; border:1px solid #333; text-align:left; padding:10px; font-family:monospace; margin-top:10px; font-size:0.8rem;"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-red" onclick="combatTurn('ATTACK')">‚öî ATTACK</button>
            <button class="btn" style="border-color:#fff; color:#fff;" onclick="combatTurn('POTION_HP')">üíâ HEAL</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = "REPLACE_ME_WITH_RENDER_URL"; // UPDATE THIS !!!
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // --- SYNTH ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function sfx(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'click') {
                osc.type = 'square'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'sheesh') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1200, now + 0.2);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'spite') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.2);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        }

        // --- APP STATE ---
        let feed = [];
        let currentBossHP = 0;

        async function init() {
            showLoader(true);
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ initData: tg.initData || "debug_mode" })
                });
                const data = await res.json();
                if (data.user.bio_lock_url) {
                    document.getElementById('hud-ap').innerText = data.user.ap;
                    showScreen('screen-feed');
                    loadFeed();
                    if (data.user.combat_state === "LOCKED") triggerAmbush();
                } else {
                    showScreen('screen-entry');
                }
            } catch(e) { alert("SERVER ERROR: " + e.message); }
            showLoader(false);
        }

        async function uploadBio() {
            sfx('click');
            const file = document.getElementById('cam').files[0];
            if (!file) return;
            document.getElementById('status-log').innerText = "UPLOADING...";
            showLoader(true);
            const fd = new FormData();
            fd.append("initData", tg.initData || "debug_mode");
            fd.append("file", file);
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                const res = await fetch(`${API_URL}/auth/biolock`, { method: "POST", body: fd, signal: controller.signal });
                clearTimeout(timeoutId);
                const data = await res.json();
                if (data.status === "success") { sfx('sheesh'); location.reload(); }
                else { alert("ERROR: " + data.msg); }
            } catch(e) { alert("UPLOAD FAILED"); }
            showLoader(false);
        }

        async function loadFeed() {
            const res = await fetch(`${API_URL}/game/feed`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ initData: tg.initData || "debug_mode" })
            });
            const data = await res.json();
            feed = data.feed;
            renderCard();
        }

        function renderCard() {
            const container = document.getElementById('feed-container');
            if (feed.length === 0) { container.innerHTML = "<div style='margin-top:100px'>NO TARGETS</div>"; return; }
            const u = feed[0];
            
            const glitchClass = u.is_pioneer ? "pioneer-glitch" : "";
            const stampHtml = u.equipped_item ? `<div class="stamp-overlay">${u.equipped_item}</div>` : '';
            
            container.innerHTML = `
                <div class="card">
                    <img src="${u.bio_lock_url}">
                    ${stampHtml}
                    <div class="card-overlay">
                        <h2 style="margin:0;" class="${glitchClass}">${u.username}</h2>
                        <div style="color:var(--neon)">${u.faction || 'NEUTRAL'}</div>
                    </div>
                </div>`;
        }

        async function swipe(dir) {
            if (feed.length === 0) return;
            
            // Audio Feedback based on choice
            if (dir === 'LIGHT') sfx('sheesh');
            else sfx('spite');

            const target = feed[0];
            const rot = dir === 'LIGHT' ? 20 : -20;
            const x = dir === 'LIGHT' ? 200 : -200;
            
            document.querySelector('.card').style.transform = `translateX(${x}px) rotate(${rot}deg)`;
            
            const res = await fetch(`${API_URL}/game/swipe`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ initData: tg.initData || "debug_mode", target_id: target.user_id, direction: dir })
            });
            const data = await res.json();
            document.getElementById('hud-ap').innerText = (parseInt(document.getElementById('hud-ap').innerText) + 1);

            if (data.status === "AMBUSH") { sfx('spite'); triggerAmbush(); }
            else { feed.shift(); setTimeout(() => renderCard(), 200); }
        }

        // --- PROFILE & PROGRESSION ---
        async function loadProfile() {
            sfx('click');
            showLoader(true);
            try {
                // Fetch fresh user data
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ initData: tg.initData || "debug_mode" })
                });
                const data = await res.json();
                const u = data.user;
                
                document.getElementById('prof-img').src = u.bio_lock_url;
                document.getElementById('prof-name').innerText = u.username;
                if(u.is_pioneer) document.getElementById('prof-name').classList.add('pioneer-glitch');
                document.getElementById('prof-faction').innerText = u.faction || "UNSORTED";
                
                // Stats
                document.getElementById('stat-str').innerText = u.base_str || 1;
                document.getElementById('stat-agi').innerText = u.base_agi || 1;
                document.getElementById('stat-int').innerText = u.base_int || 1;
                document.getElementById('avail-pts').innerText = "PTS: " + (u.stat_points_available || 0);

                // Show [+] buttons if points > 0
                const showUpgrades = (u.stat_points_available > 0);
                ['str','agi','int'].forEach(s => {
                    document.getElementById('up-'+s).classList.toggle('hidden', !showUpgrades);
                });

                // Stamp
                const stampEl = document.getElementById('prof-stamp');
                if(u.equipped_item) {
                    stampEl.innerText = u.equipped_item;
                    stampEl.classList.remove('hidden');
                } else {
                    stampEl.classList.add('hidden');
                }

                // Inventory
                const invRes = await fetch(`${API_URL}/game/inventory`, {
                     method: "POST", headers: {"Content-Type":"application/json"},
                     body: JSON.stringify({ initData: tg.initData || "debug_mode" })
                });
                const invData = await invRes.json();
                
                const list = document.getElementById('inventory-list');
                list.innerHTML = "";
                if(invData.items.length === 0) list.innerHTML = "<div style='color:#888; padding:10px;'>NO LOOT YET</div>";
                
                invData.items.forEach(i => {
                    const itemName = i.item_id;
                    list.innerHTML += `
                        <div class="inv-item">
                            <span>${itemName}</span>
                            <button class="btn" style="width:auto; margin:0; font-size:0.7rem; padding:5px;" onclick="equipItem('${itemName}')">EQUIP</button>
                        </div>`;
                });

                showScreen('screen-profile');
            } catch(e) { console.error(e); alert("ERROR"); }
            showLoader(false);
        }

        async function upgradeStat(statName) {
            sfx('click');
            try {
                const res = await fetch(`${API_URL}/game/stats/upgrade`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ initData: tg.initData || "debug_mode", stat: statName })
                });
                const data = await res.json();
                if(data.status === "UPGRADED") {
                    sfx('sheesh');
                    loadProfile(); // Refresh
                } else {
                    alert("NO POINTS");
                }
            } catch(e) { alert("FAIL"); }
        }

        async function equipItem(itemId) {
            sfx('click');
            try {
                const res = await fetch(`${API_URL}/game/equip`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ initData: tg.initData || "debug_mode", item_id: itemId })
                });
                const data = await res.json();
                if(data.status === "EQUIPPED") {
                    sfx('sheesh');
                    alert("STAMP APPLIED");
                    loadProfile();
                }
            } catch(e) { alert("FAILED"); }
        }

        async function loadLeaderboard() {
            sfx('click');
            showLoader(true);
            try {
                // Using Feed logic to get top users for MVP
                const res = await fetch(`${API_URL}/game/feed`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ initData: tg.initData || "debug_mode" })
                });
                const data = await res.json();
                
                const list = document.getElementById('leader-list');
                list.innerHTML = "";
                
                // Mock ranking visualization based on feed data
                data.feed.forEach((u, i) => {
                    list.innerHTML += `
                        <div class="leader-row">
                            <div style="display:flex; align-items:center;">
                                <span style="margin-right:10px; color:gold;">#${i+1}</span>
                                <img src="${u.bio_lock_url}">
                                <span class="${u.is_pioneer ? 'pioneer-glitch' : ''}">${u.username}</span>
                            </div>
                            <span>${u.ap || 0} AP</span>
                        </div>
                    `;
                });
                showScreen('screen-leaderboard');
            } catch(e) { alert("ERROR"); }
            showLoader(false);
        }

        // --- COMBAT ---
        function triggerAmbush() { showScreen('screen-combat'); loadCombatInfo(); }
        async function loadCombatInfo() {
            const res = await fetch(`${API_URL}/game/combat/info`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ initData: tg.initData || "debug_mode" })
            });
            const data = await res.json();
            document.getElementById('boss-hp').innerText = data.boss.hp;
            document.getElementById('boss-name').innerText = data.boss.name;
            document.getElementById('boss-img').src = `https://robohash.org/${data.boss.name}?set=set1`;
            currentBossHP = data.boss.hp;
        }
        async function combatTurn(action) {
            sfx('click');
            const res = await fetch(`${API_URL}/game/combat/turn`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ initData: tg.initData || "debug_mode", action: action, boss_hp_current: currentBossHP })
            });
            const data = await res.json();
            const log = document.getElementById('combat-log');
            data.log.forEach(l => log.innerHTML += `<div>> ${l}</div>`);
            log.scrollTop = log.scrollHeight;
            
            if (data.status === "VICTORY") {
                sfx('sheesh');
                alert(`SHEESH! LOOT: ${data.loot}`);
                location.reload();
            } else {
                currentBossHP = data.new_boss_hp;
                document.getElementById('boss-hp').innerText = currentBossHP;
                sfx('spite');
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function showLoader(v) {
            v ? document.getElementById('loader').classList.remove('hidden') : document.getElementById('loader').classList.add('hidden');
        }

        init();
    </script>
</body>
</html>
