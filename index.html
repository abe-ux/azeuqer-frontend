<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AZEUQER</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #050505; --neon: #00ffcc; --pink: #ff00ff; --glass: rgba(255,255,255,0.05); }
        body { background: var(--bg); color: #fff; font-family: monospace; margin: 0; padding: 0; overflow: hidden; }
        .hidden { display: none !important; }
        .screen { padding: 20px; text-align: center; height: 100vh; overflow-y: auto; }
        .btn { width: 100%; padding: 15px; background: transparent; border: 1px solid var(--neon); color: var(--neon); margin-top: 10px; font-size: 1rem; cursor: pointer; }
        .btn-red { border-color: var(--pink); color: var(--pink); }
        input[type=range] { width: 100%; accent-color: var(--neon); }
        /* GLITCH */
        .glitch { position: relative; color: var(--neon); animation: skew 1s infinite alternate; }
        .glitch::before { content: attr(data-text); position: absolute; left: -2px; text-shadow: 2px 0 var(--pink); clip: rect(0,900px,0,0); animation: gl 2s infinite linear alternate-reverse; }
        @keyframes gl { 0% { clip: rect(20px,999px,10px,0); } 100% { clip: rect(5px,999px,40px,0); } }
        /* CARDS */
        #card-container { position: relative; width: 300px; height: 450px; margin: 20px auto; }
        .card { width: 100%; height: 100%; background: #111; border: 1px solid #333; position: absolute; display: flex; flex-direction: column; }
        .card img { width: 100%; height: 80%; object-fit: cover; }
        .info { padding: 10px; text-align: left; }
    </style>
</head>
<body>

    <div id="screen-entry" class="screen">
        <h1 class="glitch" data-text="AZEUQER">AZEUQER</h1>
        <p>INITIALIZE VESSEL</p>
        <div style="text-align:left; background:var(--glass); padding:10px; margin:10px 0;">
            <label>WORK <input type="range" id="t-work"></label><br>
            <label>PACE <input type="range" id="t-pace"></label>
        </div>
        <label class="btn">
            üì∏  BIO-LOCK SCAN
            <input type="file" id="cam" accept="image/*" capture="user" class="hidden" onchange="doBiolock()">
        </label>
        <p id="log" style="color:#555">WAITING...</p>
    </div>

    <div id="screen-feed" class="screen hidden">
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding-bottom:10px;">
            <span>AP: <span id="hud-ap">0</span></span>
            <div style="display:flex; gap:10px;">
                <button onclick="showScreen('screen-leaderboard')" style="background:none; border:none; color:#fff;">üèÜ</button>
                <button onclick="openTribunal()" style="background:none; border:none; color:#fff;">‚öñÔ∏è</button>
            </div>
        </div>
        <div id="card-container">
            <div id="empty-msg" style="margin-top:50px;">NO SIGNALS.<br>REFRESHING...</div>
        </div>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="btn btn-red" style="width:auto;" onclick="swipe('SPITE')"> ‚ùå  SPITE</button>
            <button class="btn" style="width:auto;" onclick="swipe('LIGHT')"> ‚ö°  LIGHT</button>
        </div>
    </div>

    <div id="screen-combat" class="screen hidden" style="background:rgba(20,0,0,0.95); z-index:99; position:absolute; top:0; width:100%;">
        <h1 style="color:red">AMBUSH</h1>
        <div id="boss-stats">
            <h2>THE GATEKEEPER</h2>
            <p>HP: <span id="boss-hp">???</span></p>
        </div>
        <div id="combat-log" style="height:150px; overflow-y:scroll; border:1px solid #333; text-align:left; padding:5px; font-size:0.8rem;"></div>
        <button class="btn btn-red" onclick="combatTurn('ATTACK')">ATTACK</button>
        <button class="btn" onclick="combatTurn('POTION')">POTION</button>
    </div>

    <div id="screen-leaderboard" class="screen hidden">
        <h2>HIERARCHY</h2>
        <div id="board-list" style="text-align:left; height:40vh; overflow-y:scroll; border:1px solid #333; padding:5px;"></div>
        
        <div id="foundation-widget" style="background:#111; padding:10px; margin-top:20px; border:1px solid #333;">
            <div style="font-size:0.8rem; color:#888;">THE FOUNDATION</div>
            <div style="width:100%; background:#333; height:10px; margin:5px 0;">
                <div id="found-bar" style="width:0%; background:var(--neon); height:100%;"></div>
            </div>
            <button class="btn" style="font-size:0.8rem; padding:5px;" onclick="donate()">DONATE AP</button>
        </div>
        <button class="btn" onclick="showScreen('screen-feed')">BACK</button>
    </div>

    <div id="screen-tribunal" class="screen hidden" style="background: #1a0505;">
        <h2 style="color:var(--pink)">THE TRIBUNAL</h2>
        <div id="case-file" style="margin:20px 0; border:1px solid #444; padding:10px;">
            <div id="case-status">SEARCHING...</div>
            <img id="case-img" src="" class="hidden" style="width:150px; height:150px; object-fit:cover; margin:10px auto; display:block;">
            <h3 id="case-name"></h3>
        </div>
        <div id="verdict-controls" class="hidden">
            <button class="btn" onclick="castVerdict('APPROVE')">VERIFY (+10 AP)</button>
            <button class="btn btn-red" onclick="castVerdict('REJECT')">PURGE</button>
        </div>
        <button class="btn" onclick="showScreen('screen-feed')">EXIT COURT</button>
    </div>

    <script>
        const API_URL = "REPLACE_ME_WITH_RENDER_URL"; // PASTE YOUR URL HERE
        const tg = window.Telegram.WebApp;
        tg.expand();
        let feed = [];
        let currentBossHP = 0;
        let currentCaseId = null;

        async function init() {
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ initData: tg.initData || "debug_mode" })
                });
                const data = await res.json();
                if (data.user.bio_lock_url) {
                    showScreen('screen-feed');
                    loadFeed();
                    document.getElementById('hud-ap').innerText = data.user.ap;
                    if (data.user.combat_state === "LOCKED") triggerAmbush();
                }
            } catch(e) { console.error(e); }
        }

        async function doBiolock() {
            const file = document.getElementById('cam').files[0];
            if (!file) return;
            document.getElementById('log').innerText = "SCANNING...";
            const fd = new FormData();
            fd.append("initData", tg.initData || "debug_mode");
            fd.append("file", file);
            const res = await fetch(`${API_URL}/auth/biolock`, { method: "POST", body: fd });
            const data = await res.json();
            if(data.status === "success") { alert("CONFIRMED"); location.reload(); }
            else { alert("FAIL: " + data.msg); }
        }

        async function loadFeed() {
            const res = await fetch(`${API_URL}/game/feed`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ initData: tg.initData || "debug_mode" })
            });
            const data = await res.json();
            feed = data.feed;
            renderCard();
        }

        function renderCard() {
            const container = document.getElementById('card-container');
            container.innerHTML = "";
            if(feed.length === 0) { container.innerHTML = "<div style='margin-top:50px'>NO TARGETS</div>"; return; }
            const u = feed[0];
            container.innerHTML = `<div class="card"><img src="${u.bio_lock_url}"><div class="info"><h3>${u.username}</h3><p>${u.faction || 'NEUTRAL'}</p></div></div>`;
        }

        async function swipe(dir) {
            if(feed.length === 0) return;
            const target = feed[0];
            document.querySelector('.card').style.transform = dir === 'LIGHT' ? 'translateX(100px)' : 'translateX(-100px)';
            const res = await fetch(`${API_URL}/game/swipe`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ initData: tg.initData || "debug_mode", target_id: target.user_id, direction: dir })
            });
            const data = await res.json();
            if(data.status === "AMBUSH") triggerAmbush();
            else { feed.shift(); setTimeout(renderCard, 200); }
        }

        function triggerAmbush() { showScreen('screen-combat'); loadCombatInfo(); }
        async function loadCombatInfo() {
            const res = await fetch(`${API_URL}/game/combat/info`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ initData: tg.initData || "debug_mode" })
            });
            const data = await res.json();
            document.getElementById('boss-hp').innerText = data.boss.hp;
            currentBossHP = data.boss.hp;
        }
        async function combatTurn(act) {
            const res = await fetch(`${API_URL}/game/combat/turn`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ initData: tg.initData || "debug_mode", action: act, boss_hp_current: currentBossHP })
            });
            const data = await res.json();
            const log = document.getElementById('combat-log');
            data.log.forEach(l => log.innerHTML += `<div>> ${l}</div>`);
            if(data.status === "VICTORY") { alert("VICTORY"); location.reload(); }
            else { currentBossHP = data.new_boss_hp; document.getElementById('boss-hp').innerText = currentBossHP; }
        }

        async function openTribunal() {
            showScreen('screen-tribunal');
            const res = await fetch(`${API_URL}/game/tribunal/case`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ initData: tg.initData || "debug_mode" })
            });
            const data = await res.json();
            if(data.status === "CASE_FOUND") {
                currentCaseId = data.case.user_id;
                document.getElementById('case-img').src = data.case.bio_lock_url;
                document.getElementById('case-img').classList.remove('hidden');
                document.getElementById('case-name').innerText = data.case.username;
                document.getElementById('verdict-controls').classList.remove('hidden');
                document.getElementById('case-status').innerText = "PENDING";
            } else { document.getElementById('case-status').innerText = "NO CASES"; }
        }

        async function castVerdict(vote) {
            await fetch(`${API_URL}/game/tribunal/vote`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ initData: tg.initData || "debug_mode", target_id: currentCaseId, vote: vote })
            });
            alert("VOTED"); openTribunal();
        }

        async function donate() {
            const amt = prompt("AMOUNT:");
            if(!amt) return;
            await fetch(`${API_URL}/game/foundation/donate`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ initData: tg.initData || "debug_mode", amount: parseInt(amt) })
            });
            alert("DONATED");
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        init();
    </script>
</body>
</html>
